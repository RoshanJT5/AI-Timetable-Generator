{% extends "base.html" %}

{% block title %}Timetable - PlanSphere.AI{% endblock %}

{% block content %}
{% if user.role == 'teacher' %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> My Availability</h5>
                <button class="btn btn-sm btn-light" onclick="saveAvailability()">
                    <i class="bi bi-save"></i> Save Availability
                </button>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">
                    <i class="bi bi-info-circle"></i> Select the periods you are available to teach. The intelligent
                    scheduler will only assign you during these times.
                </p>
                <div class="alert alert-warning mb-3">
                    <i class="bi bi-exclamation-triangle"></i> <strong>Important:</strong> You must be available for at
                    least <strong>70% of total periods</strong> to ensure proper scheduling.
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered align-middle">
                        <thead class="table-light">
                            <tr>
                                <th width="15%">Day</th>
                                <th>Available Periods</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day in days %}
                            <tr>
                                <td class="fw-bold">{{ day }}</td>
                                <td>
                                    <div class="d-flex flex-wrap gap-2">
                                        {% for period in periods %}
                                        <div class="form-check">
                                            <input class="form-check-input availability-checkbox" type="checkbox"
                                                id="availability-{{ day }}-{{ period }}" data-day="{{ day }}"
                                                value="{{ period }}">
                                            <label class="form-check-label" for="availability-{{ day }}-{{ period }}">
                                                P{{ period }}
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <!-- Sidebar for Timetable History -->
    <div class="col-md-3">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="bi bi-clock-history"></i> Timetable History</h6>
            </div>
            <div class="card-body p-0" style="max-height: 600px; overflow-y: auto;">
                {% if user.role == 'admin' %}
                <div class="p-2 border-bottom sticky-top bg-white">
                    <button class="btn btn-outline-danger btn-sm w-100" onclick="resetHistory()">
                        <i class="bi bi-eraser-fill"></i> Delete All / Start Fresh
                    </button>
                </div>
                {% endif %}
                <div id="historySidebarLoading" class="text-center py-4">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="small text-muted mt-2">Loading history...</p>
                </div>

                <div id="historySidebarContent" style="display: none;">
                    <div class="list-group list-group-flush" id="historySidebarList">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div id="noHistorySidebar" style="display: none;" class="text-center py-4">
                    <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                    <p class="small text-muted mt-2">No history yet</p>
                </div>
            </div>
        </div>

        <!-- Management Section (Collapsible) -->
        {% if user.role == 'admin' %}
        <div class="card shadow-sm mt-3">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">
                    <button class="btn btn-link text-dark text-decoration-none p-0 w-100 text-start" type="button"
                        data-bs-toggle="collapse" data-bs-target="#managementSection">
                        <i class="bi bi-tools"></i> Management Controls
                        <i class="bi bi-chevron-down float-end"></i>
                    </button>
                </h6>
            </div>
            <div class="collapse" id="managementSection">
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label small text-muted">Filter Generation:</label>
                        <select class="form-select form-select-sm mb-2" id="filterProgram">
                            <option value="">All Programs</option>
                            {% for program in programs %}
                            <option value="{{ program }}">{{ program }}</option>
                            {% endfor %}
                        </select>
                        <select class="form-select form-select-sm mb-2" id="filterBranch">
                            <option value="">All Branches</option>
                            {% for branch in branches %}
                            <option value="{{ branch }}">{{ branch }}</option>
                            {% endfor %}
                        </select>
                        <select class="form-select form-select-sm mb-2" id="filterSemester">
                            <option value="">All Semesters</option>
                            {% for semester in semesters %}
                            <option value="{{ semester }}">Semester {{ semester }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button class="btn btn-success btn-sm w-100 mb-2" onclick="generateTimetable(event)">
                        <i class="bi bi-magic"></i> Generate Timetable
                    </button>
                    {% if timetable_data %}
                    <button class="btn btn-danger btn-sm w-100 mb-2" onclick="clearTimetable()">
                        <i class="bi bi-trash"></i> Clear Timetable
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Main Timetable Content -->
    <div class="col-md-9">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="page-title"><i class="bi bi-calendar-week"></i> Timetable</h2>
            <div>
                {% if timetable_data %}
                <a href="/timetable/export" class="btn btn-primary">
                    <i class="bi bi-download"></i> Export CSV
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Progress Bar for Timetable Generation -->
        <div id="generationProgressContainer" style="display: none;" class="row mb-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0">
                                <i class="bi bi-gear-fill"></i>
                                <span id="progressTitle">Generating Timetable...</span>
                            </h5>
                            <span id="progressTime" class="badge bg-primary">0s</span>
                        </div>
                        <div class="progress" style="height: 30px;">
                            <div id="progressBar"
                                class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0"
                                aria-valuemax="100">
                                <span id="progressText" class="fw-bold">0%</span>
                            </div>
                        </div>
                        <div id="progressStatus" class="mt-2 text-muted small">
                            <i class="bi bi-info-circle"></i> Initializing scheduler...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if warnings %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-warning">
                    <h5><i class="bi bi-exclamation-triangle"></i> Generation Warnings</h5>
                    <ul class="mb-0">
                        {% for warning in warnings %}
                        <li>{{ warning }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}

        {% if workload_report %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Faculty Workload Report</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Faculty</th>
                                        <th>Assigned Hours</th>
                                        <th>Min-Max Range</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for report in workload_report %}
                                    <tr>
                                        <td>
                                            <strong>{{ report.name }}</strong>
                                            {% if report.is_senior %}
                                            <span class="badge bg-warning text-dark"><i class="bi bi-star-fill"></i>
                                                Senior</span>
                                            {% endif %}
                                        </td>
                                        <td><span class="badge bg-info">{{ report.assigned_hours }} hrs</span></td>
                                        <td>{{ report.min_hours }} - {{ report.max_hours }} hrs</td>
                                        <td>
                                            {% if report.assigned_hours > 40 %}
                                            <span class="badge bg-danger">
                                                <i class="bi bi-exclamation-triangle-fill"></i> Overworked ({{
                                                report.assigned_hours }}hrs)
                                            </span>
                                            {% elif report.assigned_hours > report.max_hours %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="bi bi-exclamation-circle"></i> Above Max
                                            </span>
                                            {% elif report.assigned_hours < report.min_hours %} <span
                                                class="badge bg-secondary">
                                                <i class="bi bi-dash-circle"></i> Below Min
                                                </span>
                                                {% else %}
                                                <span class="badge bg-success">
                                                    <i class="bi bi-check-circle"></i> Optimal
                                                </span>
                                                {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if timetable_data %}
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-grid-3x3"></i> Generated Timetable</h5>
                            {% if student_groups %}
                            {% if user.role == 'admin' %}
                            <div class="form-check form-switch ms-3 d-inline-block">
                                <input class="form-check-input" type="checkbox" id="manualAssignToggle"
                                    onchange="toggleManualAssign(this)">
                                <label class="form-check-label" for="manualAssignToggle">Manual Assignments (Class
                                    columns)</label>
                            </div>
                            {% endif %}
                            <select class="form-select" style="width: auto;" id="groupFilter"
                                onchange="filterByGroup()">
                                <option value="">All Groups</option>
                                {% for group in student_groups %}
                                <option value="{{ group.name }}">{{ group.name }}</option>
                                {% endfor %}
                            </select>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <div id="manualAssignContainer" style="display:none;">
                                <div class="mb-2 d-flex align-items-center gap-2">
                                    <label class="form-label mb-0">Day:</label>
                                    <select id="manualDay" class="form-select" style="width:auto;"
                                        onchange="renderManualTable()">
                                        {% for day in days %}
                                        <option value="{{ day }}">{{ day }}</option>
                                        {% endfor %}
                                    </select>
                                    <button class="btn btn-primary ms-2" onclick="saveManualAssignments()">Save
                                        Assignments</button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-sm mb-0" id="manualTable">
                                        <!-- Will be rendered by JS -->
                                    </table>
                                </div>
                            </div>

                            <table class="table table-bordered table-sm mb-0" id="standardTable">
                                <thead class="table-light">
                                    <tr>
                                        <th class="text-center" width="10%">Time</th>
                                        {% for day in days %}
                                        <th class="text-center">{{ day }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for period in periods %}
                                    <tr>
                                        <td class="fw-bold text-center"
                                            style="background: var(--bg-card); border-right: 2px solid var(--border-color);">
                                            <div style="color: var(--text-primary); font-size: 1rem;">Period {{ period
                                                }}</div>
                                            {% if time_ranges and period in time_ranges %}
                                            <small
                                                style="color: var(--text-secondary); display: block; margin-top: 0.25rem;">{{
                                                time_ranges[period] }}</small>
                                            {% endif %}
                                        </td>
                                        {% for day in days %}
                                        <td class="p-2">
                                            {% set found_entries = [] %}
                                            {% for key, entries in timetable_data.items() %}
                                            {% if key[0] == day and key[1] == period %}
                                            {% for entry in entries %}
                                            {% set _ = found_entries.append(entry) %}
                                            {% endfor %}
                                            {% endif %}
                                            {% endfor %}
                                            {% if found_entries %}
                                            {% for entry in found_entries %}
                                            <div class="timetable-cell mb-2" data-group="{{ entry.student_group }}">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <strong class="text-primary">{{ entry.course.code }}</strong>
                                                    {% if entry.student_group %}
                                                    <span class="badge bg-secondary">{{ entry.student_group }}</span>
                                                    {% endif %}
                                                </div>
                                                <div class="text-truncate" title="{{ entry.course.name }}">
                                                    <small>{{ entry.course.name[:30] }}{% if entry.course.name|length >
                                                        30
                                                        %}...{% endif %}</small>
                                                </div>
                                                <small class="text-muted d-block mt-1">
                                                    <i class="bi bi-person"></i> {{ entry.faculty.name }}<br>
                                                    <i class="bi bi-building"></i> {{ entry.room.name }}
                                                    {% if entry.course.course_type == 'practical' %}
                                                    <span class="badge bg-warning text-dark ms-1">Lab</span>
                                                    {% endif %}
                                                </small>
                                            </div>
                                            {% endfor %}
                                            {% else %}
                                            <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                        {% endfor %}
                                    </tr>
                                    {% if period in break_map %}
                                    <tr class="table-warning">
                                        <td class="fw-bold text-center">
                                            <i class="bi bi-cup-hot"></i><br>
                                            {{ break_map[period].break_name }}<br>
                                            <small>{{ break_map[period].duration_minutes }} min</small>
                                        </td>
                                        {% for day in days %}
                                        <td class="text-center bg-warning bg-opacity-25">
                                            <strong>{{ break_map[period].break_name }}</strong><br>
                                            <small class="text-muted">{{ break_map[period].duration_minutes }}
                                                minutes</small>
                                        </td>
                                        {% endfor %}
                                    </tr>
                                    {% endif %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="info-box">
                    <h6><i class="bi bi-info-circle"></i> Legend</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <span class="badge bg-secondary">Group</span>
                        <span class="badge bg-warning text-dark">Lab Session</span>
                        <span class="badge bg-danger">Overworked (40+ hrs)</span>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="success-box">
                    <h6><i class="bi bi-check-circle"></i> Intelligent Features Active</h6>
                    <small>✓ Workload balanced | ✓ Labs prioritized | ✓ Availability respected | ✓ No consecutive
                        duplicates</small>
                </div>
            </div>
        </div>
        {% else %}
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-calendar-x" style="font-size: 4rem; color: #ccc;"></i>
                        <h4 class="mt-3 text-muted">No Timetable Generated</h4>
                        <p class="text-muted">
                            {% if user.role == 'admin' %}
                            Click "Generate Timetable" to create an intelligent, conflict-free schedule with automatic
                            workload
                            management.
                            {% else %}
                            No timetable has been generated yet. Please contact an administrator.
                            {% endif %}
                        </p>
                        {% if user.role == 'admin' %}
                        <button class="btn btn-primary btn-lg" onclick="generateTimetable(event)">
                            <i class="bi bi-magic"></i> Generate Intelligent Timetable
                        </button>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-lightbulb"></i> Make sure you've configured constraints in
                                <a href="/constraints">Scheduling Constraints</a> page
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Timetable History Modal -->
        <div class="modal fade" id="historyModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-clock-history"></i> Timetable History</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        {% if user.role == 'admin' %}
                        <div class="mb-3 d-flex justify-content-end">
                            <button type="button" class="btn btn-outline-danger" onclick="resetHistory()">
                                <i class="bi bi-eraser-fill"></i> Delete All / Start Fresh
                            </button>
                        </div>
                        {% endif %}
                        <div id="historyLoadingMessage" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading timetable history...</p>
                        </div>

                        <div id="historyContent" style="display: none;">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong>Tip:</strong> Click "Load" to restore a previous timetable without re-running
                                the
                                generator.
                            </div>

                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Generated</th>
                                            <th>Filters</th>
                                            <th>Entries</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="historyTableBody">
                                        <!-- Populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>

                            <div id="noHistoryMessage" style="display: none;" class="text-center py-4">
                                <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
                                <p class="mt-3 text-muted">No timetable history found. Generate a timetable to create
                                    the first
                                    entry.</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        {% endblock %}

        {% block scripts %}
        <script>
            const USER_ROLE = "{{ user.role }}";
            const teacherAvailability = {{ teacher_availability| tojson | safe }};

            document.addEventListener('DOMContentLoaded', () => {
                if (teacherAvailability && Object.keys(teacherAvailability).length) {
                    document.querySelectorAll('.availability-checkbox').forEach(cb => {
                        const day = cb.dataset.day;
                        const period = parseInt(cb.value, 10);
                        if (teacherAvailability[day] && teacherAvailability[day].includes(period)) {
                            cb.checked = true;
                        }
                    });
                }
            });

            function generateTimetable(evt) {
                // Capture filter values
                const program = document.getElementById('filterProgram')?.value || '';
                const branch = document.getElementById('filterBranch')?.value || '';
                const semester = document.getElementById('filterSemester')?.value || '';

                // Build filter description for confirmation
                let filterDesc = '';
                if (program || branch || semester) {
                    filterDesc = '\n\nFilters:';
                    if (program) filterDesc += `\n• Program: ${program}`;
                    if (branch) filterDesc += `\n• Branch: ${branch}`;
                    if (semester) filterDesc += `\n• Semester: ${semester}`;
                } else {
                    filterDesc = '\n\n(Generating for ALL programs, branches, and semesters)';
                }

                UI.confirm('Generate a new intelligent timetable?' + filterDesc + '\n\n✓ Automatic workload management\n✓ Lab priority allocation\n✓ Faculty availability respect\n✓ Smart lecture scheduling\n✓ Overwork detection\n\nExisting timetable entries for the selected filters will be replaced. Continue?', () => {
                    const btn = evt ? evt.target.closest('button') : null;
                    const originalText = btn ? btn.innerHTML : '';
                    if (btn) {
                        btn.disabled = true;
                        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';
                    }

                    // Show and initialize progress bar
                    const progressContainer = document.getElementById('generationProgressContainer');
                    const progressBar = document.getElementById('progressBar');
                    const progressText = document.getElementById('progressText');
                    const progressTime = document.getElementById('progressTime');
                    const progressStatus = document.getElementById('progressStatus');
                    const progressTitle = document.getElementById('progressTitle');

                    progressContainer.style.display = 'block';
                    progressBar.style.width = '0%';
                    progressBar.setAttribute('aria-valuenow', '0');
                    progressText.textContent = '0%';
                    progressTime.textContent = '0s';
                    progressStatus.innerHTML = '<i class="bi bi-info-circle"></i> Initializing scheduler...';

                    // Time tracking
                    const startTime = Date.now();
                    let progress = 0;
                    const statusMessages = [
                        'Analyzing course requirements...',
                        'Checking faculty availability...',
                        'Allocating laboratory sessions...',
                        'Balancing workload distribution...',
                        'Optimizing room assignments...',
                        'Resolving scheduling conflicts...',
                        'Validating constraints...',
                        'Finalizing timetable...'
                    ];

                    // Simulate progress updates
                    const progressInterval = setInterval(() => {
                        if (progress < 90) {
                            progress += Math.random() * 15;
                            if (progress > 90) progress = 90;

                            const statusIndex = Math.floor((progress / 90) * statusMessages.length);
                            const currentStatus = statusMessages[Math.min(statusIndex, statusMessages.length - 1)];

                            progressBar.style.width = progress + '%';
                            progressBar.setAttribute('aria-valuenow', Math.floor(progress));
                            progressText.textContent = Math.floor(progress) + '%';
                            progressStatus.innerHTML = `<i class="bi bi-gear-fill"></i> ${currentStatus}`;

                            const elapsed = Math.floor((Date.now() - startTime) / 1000);
                            progressTime.textContent = elapsed + 's';
                        }
                    }, 500);

                    // Build request payload with filters
                    const payload = {};
                    if (program) payload.program = program;
                    if (branch) payload.branch = branch;
                    // Only include semester if it's a valid positive number
                    const semesterNum = parseInt(semester);
                    if (semester && semesterNum > 0) payload.semester = semesterNum;

                    fetch('/timetable/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    })
                        .then(response => {
                            const contentType = response.headers.get('content-type');
                            if (!contentType || !contentType.includes('application/json')) {
                                throw new Error('Server returned non-JSON response. Please check server logs.');
                            }
                            return response.json();
                        })
                        .then(data => {
                            clearInterval(progressInterval);

                            progressBar.style.width = '100%';
                            progressBar.setAttribute('aria-valuenow', '100');
                            progressText.textContent = '100%';
                            const totalTime = Math.floor((Date.now() - startTime) / 1000);
                            progressTime.textContent = totalTime + 's';

                            if (btn) {
                                btn.disabled = false;
                                btn.innerHTML = originalText;
                            }

                            if (data.success) {
                                progressBar.classList.remove('bg-success');
                                progressBar.classList.add('bg-success');
                                progressStatus.innerHTML = '<i class="bi bi-check-circle-fill"></i> Timetable generated successfully!';
                                progressTitle.textContent = 'Generation Complete!';

                                let message = 'Timetable Generated Successfully';
                                UI.showToast(message, 'success');
                                setTimeout(() => {
                                    window.location.replace('/timetable?refresh=' + Date.now());
                                }, 1500);
                            } else {
                                progressBar.classList.remove('bg-success');
                                progressBar.classList.add('bg-danger');
                                progressStatus.innerHTML = '<i class="bi bi-x-circle-fill"></i> Generation failed';
                                progressTitle.textContent = 'Generation Failed';
                                setTimeout(() => { progressContainer.style.display = 'none'; }, 3000);

                                const errorMsg = data.error || data.message || 'Failed to generate timetable';
                                UI.showToast('Error: ' + errorMsg, 'error');
                            }
                        })
                        .catch(err => {
                            clearInterval(progressInterval);
                            progressBar.classList.remove('bg-success');
                            progressBar.classList.add('bg-danger');
                            progressStatus.innerHTML = '<i class="bi bi-x-circle-fill"></i> Error: ' + err.message;
                            progressTitle.textContent = 'Generation Failed';
                            setTimeout(() => { progressContainer.style.display = 'none'; }, 3000);

                            if (btn) {
                                btn.disabled = false;
                                btn.innerHTML = originalText;
                            }
                            UI.showToast('Error: ' + err.message, 'error');
                        });
                });
            }

            function clearTimetable() {
                UI.confirm('Are you sure you want to clear the timetable? This cannot be undone.', () => {
                    fetch('/timetable/clear', { method: 'POST' })
                        .then(r => r.json())
                        .then(data => {
                            if (data.success) {
                                UI.showToast('✓ Timetable cleared successfully.', 'success');
                                setTimeout(() => location.reload(), 1000);
                            } else {
                                UI.showToast('✗ Error clearing timetable', 'error');
                            }
                        });
                });
            }

            function saveAvailability() {
                const payload = {};
                document.querySelectorAll('.availability-checkbox').forEach(cb => {
                    const day = cb.dataset.day;
                    const period = parseInt(cb.value, 10);
                    if (!payload[day]) payload[day] = [];
                    if (cb.checked) payload[day].push(period);
                });

                fetch('/faculty/availability', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ availability: payload })
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            UI.showToast(data.message || '✓ Availability saved successfully!', 'success');
                        } else {
                            UI.showToast('❌ Failed to save availability: ' + (data.error || 'Unknown error'), 'error');
                        }
                    })
                    .catch(err => {
                        UI.showToast('❌ Network error: ' + err.message, 'error');
                    });
            }

            function filterByGroup() {
                const selectedGroup = document.getElementById('groupFilter').value;
                const cells = document.querySelectorAll('.timetable-cell');
                cells.forEach(cell => {
                    if (selectedGroup === '' || cell.dataset.group === selectedGroup) {
                        cell.style.display = 'block';
                    } else {
                        cell.style.display = 'none';
                    }
                });
            }

            const COURSES = {{ courses| tojson | safe }};
            const FACULTY = {{ faculty| tojson | safe }};
            const ROOMS = {{ rooms| tojson | safe }};
            const GROUPS = {{ student_groups| tojson | safe }};

            function toggleManualAssign(el) {
                const on = el.checked;
                document.getElementById('manualAssignContainer').style.display = on ? 'block' : 'none';
                document.getElementById('standardTable').style.display = on ? 'none' : 'table';
                if (on) renderManualTable();
            }

            function renderManualTable() {
                const day = document.getElementById('manualDay').value;
                const table = document.getElementById('manualTable');
                let html = '<thead class="table-light"><tr><th width="8%">Period</th>';
                GROUPS.forEach(g => { html += `<th class="text-center">${g.name}</th>`; });
                html += '</tr></thead><tbody>';
                const periods = {{ periods| tojson | safe
            }};
            periods.forEach(period => {
                html += `<tr><td class="fw-bold text-center bg-light">P${period}</td>`;
                GROUPS.forEach(g => {
                    const cellId = `cell-${day}-${period}-${g.name}`.replace(/\s+/g, '_');
                    let courseOptions = `<option value="">(none)</option>`;
                    COURSES.forEach(c => { courseOptions += `<option value="${c.id}">${c.code} - ${c.name}</option>`; });
                    let facultyOptions = `<option value="">(none)</option>`;
                    FACULTY.forEach(f => { facultyOptions += `<option value="${f.id}">${f.name}</option>`; });
                    let roomOptions = `<option value="">(none)</option>`;
                    ROOMS.forEach(r => { roomOptions += `<option value="${r.id}">${r.name}</option>`; });
                    html += `<td class="p-2">
                            <div class="mb-1"><select class="form-select form-select-sm manual-course" data-day="${day}" data-period="${period}" data-group="${g.name}" id="${cellId}-course">${courseOptions}</select></div>
                            <div class="mb-1"><select class="form-select form-select-sm manual-faculty" data-day="${day}" data-period="${period}" data-group="${g.name}" id="${cellId}-faculty">${facultyOptions}</select></div>
                            <div><select class="form-select form-select-sm manual-room" data-day="${day}" data-period="${period}" data-group="${g.name}" id="${cellId}-room">${roomOptions}</select></div>
                        </td>`;
                });
                html += '</tr>';
            });
            html += '</tbody>';
            table.innerHTML = html;

            fetch(`/timetable/entries?day=${encodeURIComponent(day)}`)
                .then(r => r.json())
                .then(data => {
                    if (!data.entries) return;
                    data.entries.forEach(e => {
                        const idBase = `cell-${day}-${e.period}-${e.student_group}`.replace(/\s+/g, '_');
                        const csel = document.getElementById(idBase + '-course');
                        const fsel = document.getElementById(idBase + '-faculty');
                        const rsel = document.getElementById(idBase + '-room');
                        if (csel) csel.value = e.course_id || '';
                        if (fsel) fsel.value = e.faculty_id || '';
                        if (rsel) rsel.value = e.room_id || '';
                    });
                }).catch(() => { });
            }

            function saveManualAssignments() {
                const day = document.getElementById('manualDay').value;
                const assignments = [];
                document.querySelectorAll('.manual-course').forEach(select => {
                    const period = select.dataset.period;
                    const group = select.dataset.group;
                    const course_id = select.value || null;
                    const facultySel = document.getElementById(`${select.id.replace('-course', '')}-faculty`);
                    const roomSel = document.getElementById(`${select.id.replace('-course', '')}-room`);
                    const faculty_id = facultySel ? (facultySel.value || null) : null;
                    const room_id = roomSel ? (roomSel.value || null) : null;
                    assignments.push({ period: period, group: group, course_id: course_id, faculty_id: faculty_id, room_id: room_id });
                });

                fetch('/timetable/manual-save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ day: day, assignments: assignments })
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            UI.showToast('Assignments saved. ' + (data.processed || 0) + ' items.', 'success');
                            if (data.warnings) UI.showToast('Warnings: ' + data.warnings.join(', '), 'warning');
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            UI.showToast('Save failed: ' + (data.error || 'Unknown error'), 'error');
                        }
                    }).catch(err => UI.showToast('Save error: ' + err.message, 'error'));
            }

            // Timetable History Functions
            function refreshHistoryLists() {
                loadTimetableHistory();
                loadHistorySidebar();
            }

            function loadTimetableHistory() {
                const loadingMsg = document.getElementById('historyLoadingMessage');
                const content = document.getElementById('historyContent');
                const tableBody = document.getElementById('historyTableBody');
                const noHistoryMsg = document.getElementById('noHistoryMessage');

                // Show loading
                loadingMsg.style.display = 'block';
                content.style.display = 'none';

                fetch('/api/timetable/history', {
                    headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }
                })
                    .then(r => {
                        const contentType = r.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            return r.json();
                        }
                        throw new Error('Invalid response format (JSON expected)');
                    })
                    .then(data => {
                        loadingMsg.style.display = 'none';
                        content.style.display = 'block';

                        if (data.success && data.histories && data.histories.length > 0) {
                            tableBody.innerHTML = '';
                            noHistoryMsg.style.display = 'none';

                            data.histories.forEach(history => {
                                const row = document.createElement('tr');

                                // Format date
                                const date = new Date(history.generated_at);
                                const dateStr = date.toLocaleString();

                                // Build filters display
                                let filtersHtml = '';
                                if (history.filters) {
                                    const filterParts = [];
                                    if (history.filters.program) filterParts.push(`Program: ${history.filters.program}`);
                                    if (history.filters.branch) filterParts.push(`Branch: ${history.filters.branch}`);
                                    if (history.filters.semester) filterParts.push(`Sem: ${history.filters.semester}`);
                                    filtersHtml = filterParts.join('<br>') || 'All';
                                }

                                // Status badge
                                const statusBadge = history.is_active
                                    ? '<span class="badge bg-success">Active</span>'
                                    : '<span class="badge bg-secondary">Archived</span>';

                                row.innerHTML = `
                            <td><strong>${history.name}</strong></td>
                            <td><small>${dateStr}</small></td>
                            <td><small>${filtersHtml}</small></td>
                            <td><span class="badge bg-info">${history.stats?.total_entries || 0}</span></td>
                            <td>${statusBadge}</td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-primary" onclick="loadHistoryTimetable(${history.id}, this)">
                                            <i class="bi bi-box-arrow-in-right"></i> Load
                                        </button>
                                        ${USER_ROLE === 'admin' ? `
                                        <button class="btn btn-sm btn-danger" onclick="deleteHistory(${history.id}, ${history.is_active})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        ` : ''}
                                    </div>
                                </td>
                        `;

                                tableBody.appendChild(row);
                            });
                        } else {
                            tableBody.innerHTML = '';
                            noHistoryMsg.style.display = 'block';
                        }
                    })
                    .catch(err => {
                        loadingMsg.style.display = 'none';
                        content.style.display = 'block';
                        UI.showToast('Failed to load history: ' + err.message, 'error');
                    });
            }

            function loadHistoryTimetable(historyId, btnElement = null) {
                UI.confirm('This will replace the current timetable with the selected history. Continue?', () => {

                    // If called from sidebar or elsewhere without passing button, try to find it
                    const btn = btnElement || (event && event.target ? event.target.closest('button') : null);
                    let originalHtml = '';
                    if (btn) {
                        originalHtml = btn.innerHTML;
                        btn.disabled = true;
                        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Loading...';
                    }

                    fetch(`/api/timetable/history/${historyId}/load`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }
                    })
                        .then(r => {
                            const contentType = r.headers.get('content-type');
                            if (contentType && contentType.includes('application/json')) {
                                return r.json();
                            }
                            throw new Error('Invalid response format (JSON expected)');
                        })
                        .then(data => {
                            if (data.success) {
                                UI.showToast('✓ ' + data.message, 'success');
                                setTimeout(() => location.reload(), 1000);
                            } else {
                                if (btn) {
                                    btn.disabled = false;
                                    btn.innerHTML = originalHtml;
                                }
                                UI.showToast('Failed to load history: ' + (data.error || 'Unknown error'), 'error');
                            }
                        })
                        .catch(err => {
                            if (btn) {
                                btn.disabled = false;
                                btn.innerHTML = originalHtml;
                            }
                            UI.showToast('Error: ' + err.message, 'error');
                        });
                });
            }

            function deleteHistory(historyId, isActive) {
                let confirmMsg = 'Are you sure you want to delete this timetable history? This cannot be undone.';
                if (isActive) {
                    confirmMsg = 'WARNING: This is the CURRENTLY ACTIVE timetable. Deleting it will also clear your current timetable view. Are you sure you want to proceed?';
                }

                UI.confirm(confirmMsg, () => {

                    fetch(`/api/timetable/history/${historyId}/delete`, {
                        method: 'DELETE',
                        headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }
                    })
                        .then(async r => {
                            const contentType = r.headers.get('content-type');
                            if (contentType && contentType.includes('application/json')) {
                                return r.json();
                            }
                            const text = await r.text();
                            throw new Error('Server returned non-JSON response: ' + text.substring(0, 100));
                        })
                        .then(data => {
                            if (data.success) {
                                UI.showToast('✓ History deleted successfully', 'success');
                                if (data.cleared_active) {
                                    location.reload(); // Reload to show empty state if active was deleted
                                } else {
                                    refreshHistoryLists(); // Just reload the lists
                                }
                            } else {
                                UI.showToast('Failed to delete: ' + (data.error || 'Unknown error'), 'error');
                            }
                        })
                        .catch(err => {
                            console.error('Delete error:', err);
                            UI.showToast('Error: ' + err.message, 'error');
                        });
                });
            }

            function resetHistory() {
                UI.confirm('🚨 FINAL WARNING: This will delete ALL timetable history and clear your CURRENT active schedule. This action is Permanent and cannot be undone.\n\nEverything else (Faculty, Courses, Rooms, etc.) will remain untouched.\n\nContinue to Start Fresh?', () => {

                    fetch('/api/timetable/history/reset', {
                        method: 'DELETE',
                        headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }
                    })
                        .then(async r => {
                            const contentType = r.headers.get('content-type');
                            if (contentType && contentType.includes('application/json')) {
                                return r.json();
                            }
                            throw new Error('Server returned non-JSON response');
                        })
                        .then(data => {
                            if (data.success) {
                                UI.showToast('✓ All history cleared. Starting fresh.', 'success');
                                setTimeout(() => location.reload(), 1000);
                            } else {
                                UI.showToast('Failed to reset: ' + (data.error || 'Unknown error'), 'error');
                            }
                        })
                        .catch(err => UI.showToast('Error: ' + err.message, 'error'));
                });
            }

            // Load history when modal is opened
            document.getElementById('historyModal')?.addEventListener('show.bs.modal', loadTimetableHistory);

            // Sidebar History Functions
            function loadHistorySidebar() {
                const loadingDiv = document.getElementById('historySidebarLoading');
                const contentDiv = document.getElementById('historySidebarContent');
                const noHistoryDiv = document.getElementById('noHistorySidebar');
                const listDiv = document.getElementById('historySidebarList');

                if (!loadingDiv) return;

                loadingDiv.style.display = 'block';
                contentDiv.style.display = 'none';
                noHistoryDiv.style.display = 'none';

                fetch('/api/timetable/history', {
                    headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }
                })
                    .then(r => {
                        const contentType = r.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            return r.json();
                        }
                        throw new Error('Invalid response format');
                    })
                    .then(data => {
                        loadingDiv.style.display = 'none';

                        if (data.success && data.histories && data.histories.length > 0) {
                            contentDiv.style.display = 'block';
                            listDiv.innerHTML = '';

                            data.histories.forEach(history => {
                                const item = document.createElement('div');
                                item.className = 'list-group-item list-group-item-action p-2';
                                if (history.is_active) item.classList.add('active');

                                const date = new Date(history.generated_at);
                                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                                let filterText = '';
                                if (history.filters) {
                                    const parts = [];
                                    if (history.filters.program) parts.push(history.filters.program.toUpperCase());
                                    if (history.filters.branch) parts.push(history.filters.branch.toUpperCase());
                                    if (history.filters.semester) parts.push(`Sem ${history.filters.semester}`);
                                    filterText = parts.join(' • ');
                                }

                                item.innerHTML = `
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <div class="flex-grow-1" style="cursor: pointer;" onclick="loadHistoryFromSidebar(${history.id}, ${history.is_active}, event)">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1 small text-truncate" style="max-width: 150px;">${filterText || 'Full Timetable'}</h6>
                                            ${history.is_active ? '<span class="badge bg-success">Active</span>' : ''}
                                        </div>
                                        <small class="text-muted">${dateStr}</small>
                                        <small class="d-block text-muted">${history.stats?.total_entries || 0} entries</small>
                                    </div>
                                    ${USER_ROLE === 'admin' ? `<button class="btn btn-link btn-sm text-danger p-0 ms-2" onclick="event.stopPropagation(); deleteHistory(${history.id}, ${history.is_active})"><i class="bi bi-trash"></i></button>` : ''}
                                </div>`;

                                listDiv.appendChild(item);
                            });
                        } else {
                            noHistoryDiv.style.display = 'block';
                        }
                    })
                    .catch(() => {
                        loadingDiv.style.display = 'none';
                        noHistoryDiv.style.display = 'block';
                    });
            }

            function loadHistoryFromSidebar(historyId, isActive, evt) {
                if (isActive) return;
                loadHistoryTimetable(historyId, evt.currentTarget);
            }

            // Load sidebar on page load
            if (document.getElementById('historySidebarList')) {
                loadHistorySidebar();
            }
        </script>
        {% endblock %}
        ```